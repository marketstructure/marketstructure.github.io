<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amir's Information Aggregator v1.8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<style>
  body {
    font-family: "Open Sans", sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  h1 {
    margin-bottom: 28px;
    font-size: 36px;
    font-weight: bold;
    line-height: 1.2;
    color: #196695;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: opacity 0.3s ease-in-out;
  }
  h1:hover {
    opacity: 0.8;
  }
  #feed-list {
    list-style-type: none;
    padding: 0;
  }
  .feed-item {
    border-bottom: 1px solid #ccc;
    padding: 10px 0;
    border-radius: 4px;
  }
  .feed-item button {
    margin-left: 10px;
  }
  .hidden {
    display: none;
  }
  #feed-summary, #excluded-terms {
    margin-top: 20px;
  }
  #error-message {
    color: rgb(174, 8, 8);
  }
  .section {
    margin-top: 30px;
    border-top: 1px solid #ccc;
    padding-top: 20px;
    background-image: linear-gradient(to bottom, #fff, #f7f7f7);
  }
  .subsection {
    margin-top: 20px;
  }
  .form-group {
    margin-bottom: 15px;
  }
  button {
    background-color: #f7f7f7;
    color: #333;
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-right: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  button:hover {
    background-color: #e5e5e5;
  }
  h3 {
    margin-bottom: 10px;
  }
</style>
</head>
<body>
    <h1>Amir's Information Aggregator v1.8</h1>
    <div id="error-message"></div>
    <ul id="feed-list"></ul>
<div id="feed-builder" class="section">
            <h2 style="color: #03055B;">Feed Builder</h2>
            ...
        
        <div class="subsection">
            <h3>News Search</h3>
           <div class="form-group">
               <label>
                   <input type="radio" name="search-engine" value="google" checked> Google News
               </label>
               <label>
                   <input type="radio" name="search-engine" value="bing"> Bing News
               </label>
               <label>
                   <input type="radio" name="search-engine" value="both"> Both
               </label>
           </div>
           
        <div class="form-group">
            <input type="text" id="keywords" placeholder="Enter keywords">
            <select id="timeframe">
                <option value="default">Default</option>
                <option value="day">Past Day</option>
                <option value="week">Past Week</option>
                <option value="month">Past Month</option>
                <option value="year">Past Year</option>
            </select>
            <button onclick="generateFeed()">Generate Feed</button>
        </div>
        <div id="generated-feed"></div>

        <div class="subsection">
            <h3>Add your own feed</h3>
            <div class="form-group">
                <input type="text" id="new-feed" placeholder="Enter RSS feed URL">
                <button onclick="addFeed()">Add Feed</button>
            </div>
        </div>

        <div class="subsection">
            <h3>Exclude Terms</h3>
            <div class="form-group">
                <input type="text" id="exclude-term" placeholder="Enter term to exclude">
                <button onclick="addExcludedTerm()">Add Excluded Term</button>
            </div>
            <div id="excluded-terms"></div>
        </div>

        <div id="feed-summary"></div>
    </div>

    <script>
        let feeds = [];
        let feedItems = [];
        let hiddenItems = new Set();
        let excludedTerms = new Set();

        function loadFeeds() {
    const storedFeeds = localStorage.getItem('rssFeeds');
    if (storedFeeds) {
        feeds = JSON.parse(storedFeeds);
        updateFeedSummary();
    }

    const storedHiddenItems = localStorage.getItem('hiddenItems');
    if (storedHiddenItems) {
        hiddenItems = new Set(JSON.parse(storedHiddenItems));
    }

    const storedExcludedTerms = localStorage.getItem('excludedTerms');
    if (storedExcludedTerms) {
        excludedTerms = new Set(JSON.parse(storedExcludedTerms));
        updateExcludedTerms();
    }

    // Fetch fresh feeds immediately on page load
    if (feeds.length > 0) {
        fetchFeeds();
    }
}

function setupAutoRefresh() {
    const REFRESH_INTERVAL = 5 * 60 * 1000; // 10 minutes in milliseconds

    function autoRefresh() {
        console.log('Auto-refreshing feeds...');
        if (feeds.length > 0) {
            fetchFeeds();
        }
    }

    // Set up interval for auto-refresh
    setInterval(autoRefresh, REFRESH_INTERVAL);

    // Also refresh when the window gains focus
    window.addEventListener('focus', autoRefresh);
}

        function saveFeedsToStorage() {
            localStorage.setItem('rssFeeds', JSON.stringify(feeds));
        }

        function saveHiddenItemsToStorage() {
            localStorage.setItem('hiddenItems', JSON.stringify(Array.from(hiddenItems)));
        }

        function saveExcludedTermsToStorage() {
            localStorage.setItem('excludedTerms', JSON.stringify(Array.from(excludedTerms)));
        }

        function addFeed() {
            const feedUrl = document.getElementById('new-feed').value;
            if (feedUrl && !feeds.includes(feedUrl)) {
                feeds.push(feedUrl);
                saveFeedsToStorage();
                updateFeedSummary();
                fetchFeeds();
                document.getElementById('new-feed').value = '';
            }
        }

        function updateFeedSummary() {
  const summary = document.getElementById('feed-summary');
  summary.style.border = '1px solid #ccc';
  summary.style.padding = '10px';
  summary.style.background = '#f7f7f7';
  summary.style.marginBottom = '20px';
  summary.style.marginTop = '10px';
  summary.innerHTML = '<h3 style="margin-top: 0; font-size: 16px;">Current Feeds:</h3>';

  if (feeds.length === 0) {
    summary.innerHTML += '<p>No feeds added yet.</p>';
  } else {
    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';
    ul.style.margin = '0';
    feeds.forEach((feed, index) => {
      const li = document.createElement('li');
      li.style.paddingBottom = '10px';
      li.style.display = 'flex';
      li.style.alignItems = 'center';
      li.style.justifyContent = 'space-between';
      const span = document.createElement('span');
      span.textContent = feed;
      span.style.marginRight = '10px';
      span.style.wordBreak = 'break-all';
      li.appendChild(span);
      const removeButton = document.createElement('button');
      removeButton.textContent = 'Remove';
      removeButton.onclick = () => removeFeed(index);
      li.appendChild(removeButton);
      ul.appendChild(li);
    });
    summary.appendChild(ul);
    const clearButton = document.createElement('button');
    clearButton.textContent = 'Clear All Feeds';
    clearButton.style.background = '#ADD8E6';
    clearButton.onclick = clearAllFeeds;
    summary.appendChild(clearButton);
  }
}
   function removeFeed(index) {
       feeds.splice(index, 1);
       saveFeedsToStorage();
       updateFeedSummary();
       fetchFeeds();
       displayFeeds();
   }
   function fetchFeeds() {
  feedItems = [];
  const errorMessage = document.getElementById('error-message');
  errorMessage.textContent = '';

  if (feeds.length === 0) {
    console.log('No feeds to fetch');
    return;
  }

  console.log('Fetching feeds:', feeds);

  const cacheBuster = new Date().getTime();
  const promises = feeds.map(feed =>
    $.ajax({
      url: `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed)}&_=${cacheBuster}`,
      dataType: 'json'
    })
    .then(data => ({ status: 'fulfilled', value: data, feed }))
    .catch(error => ({ status: 'rejected', reason: error, feed }))
  );

  Promise.all(promises)
    .then(results => {
      console.log('Fetched results:', results);
      const errors = [];
      results.forEach(result => {
        if (result.status === 'fulfilled' && result.value.status === 'ok' && Array.isArray(result.value.items)) {
          feedItems = feedItems.concat(result.value.items);
        } else {
          console.error('Error fetching feed:', result.feed, result.reason || result.value);
          errors.push(result.feed);
        }
      });
      if (errors.length > 0) {
        const errorMessageSummary = "Errors occurred while fetching some feeds. Note: too many requests within a window of time may trigger rate limits.";
        const errorMessagesDetailed = `<p>Failed to fetch:</p><ul style="list-style-type: disc;">${errors.map((message) => `<li>${message}</li>`).join("")}</ul>`;
        errorMessage.textContent = errorMessageSummary;
        const feedList = document.getElementById('feed-list');
        const errorDiv = document.createElement('div');
        errorDiv.innerHTML = errorMessagesDetailed;
        feedList.appendChild(errorDiv);
      }
      try {
        processFeeds();
      } catch (error) {
        console.error('Error processing feeds:', error);
        errorMessage.textContent = 'An unexpected error occurred. Please check the console for more details.';
      }
    })
    .catch(error => {
      console.error('Unexpected error:', error);
      errorMessage.textContent = 'An unexpected error occurred. Please check the console for more details.';
    });
}


function processFeeds() {
    console.log('Processing feeds. Total items:', feedItems.length);

    const uniqueTitles = new Set();

    // Remove duplicates and apply exclusions
    feedItems = feedItems.filter((item) => {
        const title = item.title.split(' - ')[0].trim();
        if (uniqueTitles.has(title)) return false;
        uniqueTitles.add(title);
        return !Array.from(excludedTerms).some(term => item.title.toLowerCase().includes(term.toLowerCase()))
    });

    // Sort by date
    feedItems.sort((a, b) => moment(b.pubDate).diff(moment(a.pubDate)));

    console.log('After processing. Total items:', feedItems.length);

    displayFeeds();
}
        function displayFeeds() {
            const feedList = document.getElementById('feed-list');
            feedList.innerHTML = '';

            if (feedItems.length === 0) {
                feedList.innerHTML = '<p>No items to display. Make sure you have added valid RSS feeds.</p>';
                return;
            }

            feedItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'feed-item';
                if (hiddenItems.has(item.link)) {
                    li.classList.add('hidden');
                }
                li.innerHTML = `
                    <strong>${item.title}</strong><br>
                    <small>${moment(item.pubDate).format('MMMM D, YYYY')}</small><br>
                    <a href="${item.link}" target="_blank">Read More</a>
                    <button onclick="toggleItemVisibility(this, '${item.link}')">
                        ${hiddenItems.has(item.link) ? 'Unhide' : 'Hide'}
                    </button>
                `;
                feedList.appendChild(li);
            });

            console.log('Displayed feed items:', feedItems.length);
        }

        function toggleItemVisibility(button, itemLink) {
            const listItem = button.closest('.feed-item');
            if (hiddenItems.has(itemLink)) {
                hiddenItems.delete(itemLink);
                listItem.classList.remove('hidden');
                button.textContent = 'Hide';
            } else {
                hiddenItems.add(itemLink);
                listItem.classList.add('hidden');
                button.textContent = 'Unhide';
            }
            saveHiddenItemsToStorage();
        }

   
       function generateFeed() {
         const keywords = document.getElementById('keywords').value;
         const searchEngine = document.querySelector('input[name="search-engine"]:checked').value;
         const timeframe = document.getElementById('timeframe').value;
       
         function getGoogleFeedUrl(keywords, timeframe) {
           let url = `https://news.google.com/rss/search?q=${encodeURIComponent(keywords)}&hl=en-US&gl=US&ceid=US:en`;
           if (timeframe !== 'default') {
             const timeMap = { day: '1d', week: '7d', month: '1m', year: '1y' };
             url += `&when=${timeMap[timeframe]}`;
           }
           return url;
         }
       
         function getBingFeedUrl(keywords, timeframe) {
           let url = `https://www.bing.com/news/search?q=${encodeURIComponent(keywords)}&format=rss`;
           if (timeframe !== 'default' && timeframe !== 'year') {
             const timeMap = { day: 'Day', week: 'Week', month: 'Month' };
             url += `&tf=${timeMap[timeframe]}`;
           }
           return url;
         }
       
         let feedUrls = [];
       
         if (searchEngine === 'google' || searchEngine === 'both') {
           feedUrls.push(getGoogleFeedUrl(keywords, timeframe));
         }
         if (searchEngine === 'bing' || searchEngine === 'both') {
           feedUrls.push(getBingFeedUrl(keywords, timeframe));
         }
       
         feedUrls.forEach(feedUrl => {
           if (!feeds.includes(feedUrl)) {
             feeds.push(feedUrl);
           }
         });
       
         saveFeedsToStorage();
         updateFeedSummary();
         fetchFeeds();
       
         const generatedFeedDiv = document.getElementById('generated-feed');
         generatedFeedDiv.innerHTML = `<p>Feed(s) added: ${feedUrls.join(', ')}</p>`;
       }
 
        function clearAllFeeds() {
            feeds = [];
            feedItems = [];
            hiddenItems.clear();
            saveFeedsToStorage();
            saveHiddenItemsToStorage();
            updateFeedSummary();
            displayFeeds();
        }

        function addExcludedTerm() {
            const term = document.getElementById('exclude-term').value.trim();
            if (term && !excludedTerms.has(term)) {
                excludedTerms.add(term);
                saveExcludedTermsToStorage();
                updateExcludedTerms();
                document.getElementById('exclude-term').value = '';
                fetchFeeds(); // Refresh feeds to apply new exclusion
            }
        }

        function updateExcludedTerms() {
            const excludedTermsDiv = document.getElementById('excluded-terms');
            excludedTermsDiv.style.border = '1px solid #ccc';
            excludedTermsDiv.style.padding = '10px';
            excludedTermsDiv.style.background = '#f7f7f7'; // add light gray background
            excludedTermsDiv.style.marginBottom = '20px'; // add some space below the box
            excludedTermsDiv.innerHTML = '<h4 style="margin-top: 0;">Excluded Terms:</h4>';
            if (excludedTerms.size === 0) {
                excludedTermsDiv.innerHTML += '<p>No terms excluded.</p>';
            } else {
                const ul = document.createElement('ul');
                ul.style.listStyle = 'none'; // remove default list styling
                ul.style.padding = '0'; // remove default list padding
                ul.style.margin = '0'; // remove default list margin
                excludedTerms.forEach(term => {
                    const li = document.createElement('li');
                    li.style.paddingBottom = '10px'; // add some space between list items
                    const span = document.createElement('span');
                    span.textContent = term;
                    span.style.marginRight = '10px'; // add some space between term and button
                    li.appendChild(span);
                    const removeButton = document.createElement('button');
                    removeButton.textContent = 'Remove';
                    removeButton.onclick = () => removeExcludedTerm(term);
                    li.appendChild(removeButton);
                    ul.appendChild(li);
                });
                excludedTermsDiv.appendChild(ul);
                    const clearButton = document.createElement('button');
                    clearButton.textContent = 'Clear All Exclusions';
                    clearButton.style.background = '#ADD8E6'; // change background color to light blue
                    clearButton.onclick = clearAllExclusions;
                    excludedTermsDiv.appendChild(clearButton);
                }
        }

        function removeExcludedTerm(term) {
            excludedTerms.delete(term);
            saveExcludedTermsToStorage();
            updateExcludedTerms();
            fetchFeeds(); // Refresh feeds to apply updated exclusions
        }

        function clearAllExclusions() {
            excludedTerms.clear();
            saveExcludedTermsToStorage();
            updateExcludedTerms();
            fetchFeeds(); // Refresh feeds to apply updated exclusions
        }

        // Load feeds and set up auto-refresh on page load
loadFeeds();
setupAutoRefresh();
    </script>
</body>
</html>
