<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amir's Information Aggregator v1.8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <style>
        body {
            font-family: "Open Sans", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #fffefc; /* Subtle off-white background */
        }
        h1 {
            margin-bottom: 28px;
            padding-top: 30px;
            font-size: 31px;
            font-weight: bold;
            line-height: 1.2;
            color: #2c3e50;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease-in-out;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        h1:hover {
            opacity: 0.8;
        }
        #feed-list {
            list-style-type: none;
            padding: 0;
        }
        .feed-item {
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .feed-item:hover {
            background-color: #f0f8ff; /* Light blue background on hover */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }
        .feed-item strong {
            transition: color 0.3s ease;
        }
        .feed-item:hover strong {
            color: #0066cc; /* Change title color on hover */
        }
        .feed-item a {
            text-decoration: none;
            color: #0066cc;
            transition: color 0.3s ease;
        }
        .feed-item:hover a {
            color: #004499; /* Darker blue for links on hover */
        }
        .feed-item button {
            margin-left: 10px;
        }
        .hidden {
            display: none;
        }
        #feed-summary, #excluded-terms {
            margin-top: 20px;
        }
        #error-message {
            color: rgb(174, 8, 8);
        }
        .section {
            margin-top: 30px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
            background-image: linear-gradient(to bottom, #fff, #f7f7f7);
        }
        .subsection {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        button {
            background-color: #f7f7f7;
            color: #333;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #e5e5e5;
        }
        h3 {
            margin-bottom: 10px;
        }
        
        #generate-feed-btn {
            background-color: #e6f3ff;
        }
        
        /* Styles for the hamburger menu */
        .hamburger-menu {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            transition: left 0.3s ease-in-out;
        }
        .hamburger-menu.active {
         left: 0;
        }
        .menu-items {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #f5faff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .menu-items.active {
            display: block;
        }
        
        #menu-items-list ul {
            list-style: none;
            padding: 0;
        }
        
        #menu-items-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        #menu-items-list li span {
            margin-right: 10px;
            word-break: break-all;
        }
        
        #menu-items-list button {
            margin-left: 10px;
        }
        
        /* Add this new rule */
        #feed-builder > div {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        /* General menu styles */
        .menu {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .menu-item {
            padding: 10px 15px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .menu-item:hover {
            background-color: #e0e0e0;
        }
        
        .menu-item a {
            text-decoration: none;
            color: #333;
        }
        
        /* Special style for the Home item */
        .menu-item.home {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .menu-item.home a {
            color: white;
        }
        
        #saved-configs ul {
            list-style-type: none;
            padding: 0;
        }
        
        #saved-configs li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        #saved-configs li button {
            margin-left: 10px;
        }
        
        /* Updated styles for feed-specific terms */
        #feed-specific-terms-container {
            margin-top: 20px;
        }
        
        #feed-specific-terms-container button {
            margin-top: 10px;
        }
        
        .feed-specific-terms-item {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        #feed-specific-terms h4 {
            font-size: 0.85em;
            margin-top: 0;
            margin-bottom: 5px;
            font-weight: normal;
            color: #666;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        #feed-specific-terms h5 {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        #feed-specific-terms ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        #feed-specific-terms li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #feed-specific-terms li span {
            font-size: 0.85em;
            margin-right: 15px;
            word-break: break-all;
            flex-grow: 1;
        }
        
        #feed-specific-terms button {
            flex-shrink: 0;
        }
        
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); /* Lighter semi-transparent black */
            z-index: 999;
        }
    </style>
   
</head>
<body>
    <h1>Amir's Information Aggregator v1.8</h1>
    <div id="error-message"></div>
    <ul id="feed-list"></ul>
<div id="feed-builder" class="section">
            <h2 style="color: #03055B;">Feed Builder</h2>
            
            <div class="subsection">
                <h3>Set Page Title</h3>
                <div class="form-group">
                    <input type="text" id="page-title" placeholder="Enter page title">
                    <button onclick="setPageTitle()">Set Title</button>
                </div>
                <p id="title-status"></p>
            </div>
            
            <div>
                <h3>News Search</h3>
               <div class="form-group">
                   <label>
                       <input type="radio" name="search-engine" value="google" checked> Google News
                   </label>
                   <label>
                       <input type="radio" name="search-engine" value="bing"> Bing News
                   </label>
                   <label>
                       <input type="radio" name="search-engine" value="both"> Both
                   </label>
               </div>
               
            <div class="form-group">
                <input type="text" id="keywords" placeholder="Enter keywords">
                <select id="timeframe">
                    <option value="default">Default</option>
                    <option value="day">Past Day</option>
                    <option value="week">Past Week</option>
                    <option value="month">Past Month</option>
                    <option value="year">Past Year</option>
                </select>
                <button onclick="generateFeed()" id="generate-feed-btn">Generate Feed</button>
            </div>
            <div id="generated-feed"></div>
            </div>

            <div class="subsection">
                <h3>Add your own feed</h3>
                <div class="form-group">
                    <input type="text" id="new-feed" placeholder="Enter RSS feed URL">
                    <input type="checkbox" id="unfiltered-feed" name="unfiltered-feed">
                    <label for="unfiltered-feed">Unfiltered</label>
                    <button onclick="addFeed()">Add Feed</button>
                </div>
            </div>

            
            <div class="subsection">
                <h3>Current Feeds</h3>
                <div id="feed-summary"></div>
            </div>
            
            <div class="subsection">
                <h3>Feed-Specific Filter</h3>
                <div id="feed-specific-terms-container">
                    <select id="feed-selector"></select>
                    <input type="text" id="feed-specific-term" placeholder="Enter term">
                    <select id="term-type">
                        <option value="required">Required</option>
                        <option value="excluded">Excluded</option>
                    </select>
                    <button onclick="addFeedSpecificTerm()">Add Term</button>
                    <div id="feed-specific-terms"></div>
                </div>
            </div>
            
            <div class="subsection">
                <h3>General Filter By Required Terms</h3>
                <div class="form-group">
                    <input type="text" id="required-term" placeholder="Enter term to require">
                    <button onclick="addRequiredTerm()">Add Required Term</button>
                </div>
                <div id="required-terms"></div>
            </div>

            <div class="subsection">
                <h3>General Filter by Excluded Terms</h3>
                <div class="form-group">
                    <input type="text" id="exclude-term" placeholder="Enter term to exclude">
                    <button onclick="addExcludedTerm()">Add Excluded Term</button>
                </div>
                <div id="excluded-terms"></div>
            </div>

            <div class="subsection">
                <h3>Configure Menu</h3>
                <!-- ... (rest of your existing code) ... -->

            <div class="subsection">
                <h3>Configure Menu</h3>
                <div class="form-group">
                    <input type="text" id="menu-item-name" placeholder="Menu Item Name">
                    <input type="text" id="menu-item-url" placeholder="URL">
                    <button onclick="addMenuItem()">Create Menu Item</button>
                </div>
                <div id="menu-items-list"></div>
                <!-- Move the sub-heading here -->
                <div id="saved-menu-configs"></div>
                <div class="form-group">
                    <input type="text" id="menu-config-name" placeholder="Menu Configuration Name">
                    <button onclick="saveMenuConfiguration()">Save Menu Configuration</button>
                    <button onclick="loadMenuConfiguration()">Load Menu Configuration</button>
                </div>
            </div>

            <div class="subsection">
                <h3>Configuration Management</h3>
                <div class="form-group">
                    <input type="text" id="config-name" placeholder="Configuration Name">
                    <button onclick="saveConfiguration()">Save Configuration</button>
                    <button onclick="loadConfiguration()">Load Configuration</button>
                </div>
                <div id="saved-configs"></div>
            </div>

            <button onclick="generateUserVersion()">Generate User Version</button>
        </div>

        <div id="overlay"></div>

        <script>
            let feeds = [];
            let feedItems = [];
            let hiddenItems = new Set();
            let excludedTerms = new Set();
            let requiredTerms = new Set();
            let menuItems = [];

            window.onerror = function(message, source, lineno, colno, error) {
                console.error('An error occurred:', message, 'at', source, 'line', lineno);
                return false;
            };

            function loadFeeds() {
    const storedFeeds = localStorage.getItem('rssFeeds');
    if (storedFeeds) {
        feeds = JSON.parse(storedFeeds);
        updateFeedSummary();
        updateFeedSelector(); // Add this line
    }

    const storedHiddenItems = localStorage.getItem('hiddenItems');
    if (storedHiddenItems) {
        hiddenItems = new Set(JSON.parse(storedHiddenItems));
    }

    const storedExcludedTerms = localStorage.getItem('excludedTerms');
    if (storedExcludedTerms) {
        excludedTerms = new Set(JSON.parse(storedExcludedTerms));
        updateExcludedTerms();
    }

    const storedRequiredTerms = localStorage.getItem('requiredTerms');
    if (storedRequiredTerms) {
        requiredTerms = new Set(JSON.parse(storedRequiredTerms));
        updateRequiredTerms();
    }

    // Fetch fresh feeds immediately on page load
    if (feeds.length > 0) {
        fetchFeeds();
    }

    updateFeedSpecificTerms(); // Add this line
}

    function setupAutoRefresh() {
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 10 minutes in milliseconds

        function autoRefresh() {
            console.log('Auto-refreshing feeds...');
            if (feeds.length > 0) {
                fetchFeeds();
            }
        }

        // Set up interval for auto-refresh
        setInterval(autoRefresh, REFRESH_INTERVAL);

        // Also refresh when the window gains focus
        window.addEventListener('focus', autoRefresh);
    }

            function saveFeedsToStorage() {
                localStorage.setItem('rssFeeds', JSON.stringify(feeds));
            }

            function saveHiddenItemsToStorage() {
                localStorage.setItem('hiddenItems', JSON.stringify(Array.from(hiddenItems)));
            }

            function saveExcludedTermsToStorage() {
                localStorage.setItem('excludedTerms', JSON.stringify(Array.from(excludedTerms)));
            }

            function saveRequiredTermsToStorage() {
                localStorage.setItem('requiredTerms', JSON.stringify(Array.from(requiredTerms)));
            }

            function saveMenuItemsToStorage() {
                localStorage.setItem('menuItems', JSON.stringify(menuItems));
            }

            function loadMenuItems() {
                const storedMenuItems = localStorage.getItem('menuItems');
                if (storedMenuItems) {
                    menuItems = JSON.parse(storedMenuItems);
                    updateMenuItemsList();
                }
            }

            function addFeed() {
    const feedUrl = document.getElementById('new-feed').value;
    const isUnfiltered = document.getElementById('unfiltered-feed').checked;
    if (feedUrl && !feeds.some(feed => feed.url === feedUrl)) {
        feeds.push({ 
            url: feedUrl, 
            unfiltered: isUnfiltered,
            requiredTerms: [],
            excludedTerms: []
        });
        saveFeedsToStorage();
        updateFeedSummary();
        updateFeedSelector(); // Add this line
        fetchFeeds();
        document.getElementById('new-feed').value = '';
        document.getElementById('unfiltered-feed').checked = false;
    }
}

function updateFeedSummary() {
    const summary = document.getElementById('feed-summary');
    summary.innerHTML = ''; // Remove the "Current Feeds:" heading
    if (feeds.length === 0) {
        summary.innerHTML = '<p>No feeds added yet.</p>';
    } else {
        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none';
        ul.style.padding = '0';
        feeds.forEach((feed, index) => {
            const li = document.createElement('li');
            li.style.marginBottom = '10px';
            li.style.display = 'flex';
            li.style.alignItems = 'center';

            const feedUrl = typeof feed === 'string' ? feed : feed.url;
            const isUnfiltered = typeof feed === 'object' && feed.unfiltered;
            
            const feedInfo = document.createElement('div');
            feedInfo.style.flex = '1';
            feedInfo.style.padding = '5px 10px';
            feedInfo.style.backgroundColor = '#f0f0f0';
            feedInfo.style.borderRadius = '4px';
            feedInfo.style.marginRight = '10px';
            feedInfo.style.wordBreak = 'break-all';
            feedInfo.style.fontSize = '14px';
            feedInfo.textContent = feedUrl;
            
            if (isUnfiltered) {
                const unfilteredBadge = document.createElement('span');
                unfilteredBadge.textContent = ' [Unfiltered]';
                unfilteredBadge.style.marginLeft = '5px';
                unfilteredBadge.style.color = '#0066cc';
                unfilteredBadge.style.fontWeight = 'bold';
                feedInfo.appendChild(unfilteredBadge);
            }
            
            li.appendChild(feedInfo);

            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => removeFeed(index);
            li.appendChild(removeButton);
            
            ul.appendChild(li);
        });
        summary.appendChild(ul);
    }
}

function removeFeed(index) {
    const removedFeed = feeds[index];
    feeds.splice(index, 1);
    saveFeedsToStorage();
    updateFeedSummary();
    
    // Remove items from the removed feed
    feedItems = feedItems.filter(item => {
        const itemFeed = typeof removedFeed === 'string' ? removedFeed : removedFeed.url;
        return item.feedUrl !== itemFeed;
    });
    
    // Update the feed selector
    updateFeedSelector();
    
    // Update feed-specific terms display
    updateFeedSpecificTerms();
    
    // Re-process and display the remaining feeds
    processFeeds();
}

function fetchFeeds() {
    document.getElementById('feed-list').innerHTML = ''; // Clear existing feed items
    feedItems = [];
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = '';

    if (feeds.length === 0) {
        console.log('No feeds to fetch');
        return;
    }

    console.log('Fetching feeds:', feeds);

    const cacheBuster = new Date().getTime();
    const apiKey = 'xfgfsjdb84ucakiobgoy2jozqyfpf6ufhmifyjvi';
    const promises = feeds.map(feed => {
        const feedUrl = typeof feed === 'string' ? feed : feed.url;
        return $.ajax({
            url: `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}&api_key=${apiKey}&_=${cacheBuster}`,
            dataType: 'json'
        })
        .then(data => ({ status: 'fulfilled', value: data, feed }))
        .catch(error => ({ status: 'rejected', reason: error, feed }));
    });

    Promise.all(promises)
        .then(results => {
            console.log('Fetched results:', results);
            const errors = [];
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value.status === 'ok' && Array.isArray(result.value.items)) {
                    const items = result.value.items.map(item => {
                        // Decode the URL if it's a Bing News URL
                        if (item.link.includes('bing.com/news/apiclick.aspx')) {
                            const urlParams = new URLSearchParams(item.link);
                            item.link = decodeURIComponent(urlParams.get('url'));
                        }
                        return {
                            ...item,
                            feedTitle: result.value.feed.title,
                            feedUrl: typeof result.feed === 'string' ? result.feed : result.feed.url
                        };
                    });
                    feedItems = feedItems.concat(items);
                } else {
                    console.error('Error fetching feed:', result.feed, result.reason || result.value);
                    errors.push(typeof result.feed === 'string' ? result.feed : result.feed.url);
                }
            });
            if (errors.length > 0) {
                const errorMessageSummary = "Errors occurred while fetching some feeds.";
                const errorMessagesDetailed = `<p>Failed to fetch:</p><ul style="list-style-type: disc;">${errors.map((message) => `<li>${message}</li>`).join("")}</ul>`;
                errorMessage.textContent = errorMessageSummary;
                const feedList = document.getElementById('feed-list');
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = errorMessagesDetailed;
                feedList.appendChild(errorDiv);
            }
            processFeeds();
        })
        .catch(error => {
            console.error('Unexpected error:', error);
            errorMessage.textContent = 'An unexpected error occurred. Please check the console for more details.';
        });
}

function processFeeds() {
    console.log('Processing feeds. Total items:', feedItems.length);

    const uniqueTitles = new Set();

    feedItems = feedItems.filter((item) => {
        const title = item.title.split(' - ')[0].trim();
        if (uniqueTitles.has(title)) return false;
        uniqueTitles.add(title);

        const feed = feeds.find(f => f.url === item.feedUrl);
        if (!feed) return false;

        if (feed.unfiltered) {
            return true; // Skip filtering for unfiltered feeds
        }

        // Decode HTML entities in the title
        const decodedTitle = decodeHTMLEntities(item.title.toLowerCase());
        
        // Extract domain from item.link
        let domain = '';
        try {
            const url = new URL(item.link);
            domain = url.hostname.replace('www.', '');
        } catch (e) {
            console.error('Error extracting domain:', e);
        }

        const combinedText = `${decodedTitle} ${domain}`;

        // Log for debugging
        console.log('Combined text for filtering:', combinedText);

        // Function to check if a term matches, including domain-like formats
        const termMatches = (term, text) => {
            const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`\\b${escapedTerm}\\b|${escapedTerm}(?=\\.)`, 'i');
            return regex.test(text);
        };

        // If the feed has specific terms, use only those
        if (feed.requiredTerms && feed.requiredTerms.length > 0 || feed.excludedTerms && feed.excludedTerms.length > 0) {
            const hasFeedRequiredTerm = !feed.requiredTerms || feed.requiredTerms.length === 0 || feed.requiredTerms.some(term => 
                termMatches(term, combinedText)
            );

            const hasFeedExcludedTerm = feed.excludedTerms && feed.excludedTerms.some(term => 
                termMatches(term, combinedText)
            );

            return hasFeedRequiredTerm && !hasFeedExcludedTerm;
        } else {
            // If no feed-specific terms, use global terms
            const hasGlobalRequiredTerm = requiredTerms.size === 0 || Array.from(requiredTerms).some(term => 
                termMatches(term, combinedText)
            );

            const hasGlobalExcludedTerm = Array.from(excludedTerms).some(term => 
                termMatches(term, combinedText)
            );

            return hasGlobalRequiredTerm && !hasGlobalExcludedTerm;
        }
    });

    // Sort by date
    feedItems.sort((a, b) => moment(b.pubDate).diff(moment(a.pubDate)));

    console.log('After processing. Total items:', feedItems.length);

    displayFeeds();
}

// Add this helper function to decode HTML entities
function decodeHTMLEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}

            function displayFeeds() {
                const feedList = document.getElementById('feed-list');
                feedList.innerHTML = '';

                if (feedItems.length === 0) {
                    feedList.innerHTML = '<p>No items to display.</p>';
                    return;
                }

                feedItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'feed-item';
                    if (hiddenItems.has(item.link)) {
                        li.classList.add('hidden');
                    }

                    // Extract title and source
                    let title = item.title;
                    let source;

                    // Check if the title already contains a source (typical for Google News)
                    if (item.title.includes(' - ')) {
                        // Keep the title as is, it already has the source
                        source = '';
                    } else {
                        // Extract domain name from the link
                        try {
                            const url = new URL(item.link);
                            source = url.hostname.replace('www.', '');
                        } catch (e) {
                            source = 'Unknown Source';
                        }
                        // Append the source to the title
                        title += ` - ${source}`;
                    }

                    li.innerHTML = `
                        <strong>${title}</strong><br>
                        <small>${moment(item.pubDate).format('MMMM D, YYYY, h:mm a')}</small><br>
                        <a href="${item.link}" target="_blank">Read More</a>
                        <button onclick="toggleItemVisibility(this, '${item.link}')">
                            ${hiddenItems.has(item.link) ? 'Unhide' : 'Hide'}
                        </button>
                    `;
                    feedList.appendChild(li);
                });

                console.log('Displayed feed items:', feedItems.length);
            }

            function toggleItemVisibility(button, itemLink) {
                const listItem = button.closest('.feed-item');
                if (hiddenItems.has(itemLink)) {
                    hiddenItems.delete(itemLink);
                    listItem.classList.remove('hidden');
                    button.textContent = 'Hide';
                } else {
                    hiddenItems.add(itemLink);
                    listItem.classList.add('hidden');
                    button.textContent = 'Unhide';
                }
                saveHiddenItemsToStorage();
            }

       
            function generateFeed() {
    const keywords = document.getElementById('keywords').value;
    const searchEngine = document.querySelector('input[name="search-engine"]:checked').value;
    const timeframe = document.getElementById('timeframe').value;

    function getGoogleFeedUrl(keywords, timeframe) {
        let url = `https://news.google.com/rss/search?q=${encodeURIComponent(keywords)}&hl=en-US&gl=US&ceid=US:en`;
        if (timeframe !== 'default') {
            const timeMap = { day: '1d', week: '7d', month: '1m', year: '1y' };
            url += `&when=${timeMap[timeframe]}`;
        }
        return url;
    }

    function getBingFeedUrl(keywords, timeframe) {
        let url = `https://www.bing.com/news/search?q=${encodeURIComponent(keywords)}&format=rss`;
        if (timeframe !== 'default' && timeframe !== 'year') {
            const timeMap = { day: 'Day', week: 'Week', month: 'Month' };
            url += `&tf=${timeMap[timeframe]}`;
        }
        return url;
    }

    let feedUrls = [];

    if (searchEngine === 'google' || searchEngine === 'both') {
        feedUrls.push(getGoogleFeedUrl(keywords, timeframe));
    }
    if (searchEngine === 'bing' || searchEngine === 'both') {
        feedUrls.push(getBingFeedUrl(keywords, timeframe));
    }

    feedUrls.forEach(feedUrl => {
        if (!feeds.some(feed => feed.url === feedUrl)) {
            feeds.push({
                url: feedUrl,
                unfiltered: false,
                requiredTerms: [],
                excludedTerms: []
            });
        }
    });

    saveFeedsToStorage();
    updateFeedSummary();
    updateFeedSelector();
    fetchFeeds();

    const generatedFeedDiv = document.getElementById('generated-feed');
    generatedFeedDiv.innerHTML = `<p>Feed(s) added: ${feedUrls.join(', ')}</p>`;

    document.getElementById('keywords').value = '';
}
     
            function clearAllFeeds() {
                feeds = [];
                feedItems = [];
                hiddenItems.clear();
                saveFeedsToStorage();
                saveHiddenItemsToStorage();
                updateFeedSummary();
                displayFeeds();
            }

            function addExcludedTerm() {
                const term = document.getElementById('exclude-term').value.trim();
                if (term && !excludedTerms.has(term)) {
                    excludedTerms.add(term);
                    saveExcludedTermsToStorage();
                    updateExcludedTerms();
                    document.getElementById('exclude-term').value = '';
                    fetchFeeds(); // Refresh feeds to apply new exclusion
                }
            }

            function updateExcludedTerms() {
                const excludedTermsDiv = document.getElementById('excluded-terms');
                excludedTermsDiv.style.border = '1px solid #ccc';
                excludedTermsDiv.style.padding = '10px';
                excludedTermsDiv.style.background = '#f7f7f7'; // add light gray background
                excludedTermsDiv.style.marginBottom = '20px'; // add some space below the box
                excludedTermsDiv.innerHTML = '<h4 style="margin-top: 0;">Excluded Terms:</h4>';
                if (excludedTerms.size === 0) {
                    excludedTermsDiv.innerHTML += '<p>No terms excluded.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.style.listStyle = 'none'; // remove default list styling
                    ul.style.padding = '0'; // remove default list padding
                    ul.style.margin = '0'; // remove default list margin
                    excludedTerms.forEach(term => {
                        const li = document.createElement('li');
                        li.style.paddingBottom = '10px'; // add some space between list items
                        const span = document.createElement('span');
                        span.textContent = term;
                        span.style.marginRight = '10px'; // add some space between term and button
                        li.appendChild(span);
                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.onclick = () => removeExcludedTerm(term);
                        li.appendChild(removeButton);
                        ul.appendChild(li);
                    });
                    excludedTermsDiv.appendChild(ul);
                        const clearButton = document.createElement('button');
                        clearButton.textContent = 'Clear All Exclusions';
                        clearButton.style.background = '#ADD8E6'; // change background color to light blue
                        clearButton.onclick = clearAllExclusions;
                        excludedTermsDiv.appendChild(clearButton);
                    }
            }

            function removeExcludedTerm(term) {
                excludedTerms.delete(term);
                saveExcludedTermsToStorage();
                updateExcludedTerms();
                fetchFeeds(); // Refresh feeds to apply updated exclusions
            }

            function clearAllExclusions() {
                excludedTerms.clear();
                saveExcludedTermsToStorage();
                updateExcludedTerms();
                fetchFeeds(); // Refresh feeds to apply updated exclusions
            }

            function setPageTitle() {
                const newTitle = document.getElementById('page-title').value.trim();
                if (newTitle) {
                    document.title = newTitle;
                    const h1Element = document.querySelector('h1');
                    if (h1Element) {
                        h1Element.textContent = newTitle;
                    }
                    document.getElementById('title-status').textContent = `Page Title set to: "${newTitle}"`;
                    localStorage.setItem('customPageTitle', newTitle);
                } else {
                    document.getElementById('title-status').textContent = "Please enter a valid title.";
                }
            }

            function loadCustomTitle() {
                const savedTitle = localStorage.getItem('customPageTitle');
                if (savedTitle) {
                    document.title = savedTitle;
                    const h1Element = document.querySelector('h1');
                    if (h1Element) {
                        h1Element.textContent = savedTitle;
                    }
                    document.getElementById('page-title').value = savedTitle;
                    document.getElementById('title-status').textContent = `Page Title set to: "${savedTitle}"`;
                }
            }

            function addMenuItem() {
                const name = document.getElementById('menu-item-name').value.trim();
                const url = document.getElementById('menu-item-url').value.trim();
                if (name && url) {
                    menuItems.push({ name, url });
                    saveMenuItemsToStorage(); // Save to localStorage
                    updateMenuItemsList();
                    document.getElementById('menu-item-name').value = '';
                    document.getElementById('menu-item-url').value = '';
                }
            }

            function updateMenuItemsList() {
                const menuList = document.getElementById('menu-items-list');
                menuList.innerHTML = '';
                menuItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'menu-item' + (item.name.toLowerCase() === 'home' ? ' home' : '');
                    li.innerHTML = `<a href="${item.url}" target="_blank">${item.name}</a> <button onclick="removeMenuItem(${index})">Remove</button>`;
                    menuList.appendChild(li);
                });
            }

            function removeMenuItem(index) {
                menuItems.splice(index, 1);
                saveMenuItemsToStorage(); // Save to localStorage
                updateMenuItemsList();
            }

      
            function generateUserVersion() {
    const customTitle = localStorage.getItem('customPageTitle') || "RSS Feed Reader";

    // Create a new HTML document
    const doc = document.implementation.createHTMLDocument(customTitle);

    // Copy the head content
    doc.head.innerHTML = document.head.innerHTML;

    // Add additional styles for the hamburger menu
    const additionalStyles = doc.createElement('style');
    additionalStyles.textContent = `
        body {
            font-family: "Open Sans", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-color: #fffefc; /* Subtle off-white background */
        }
        .hamburger-menu {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        .hamburger-menu > button {
            background-color: #f5faff;
            color: #0066cc;
            border: 1px solid #0066cc;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .menu-items {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #f5faff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .menu-items.active {
            display: block;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #0066cc;
        }
        #menu-items-list {
            list-style-type: none;
            padding: 0;
            margin-top: 40px;
        }
        #menu-items-list li {
            margin-bottom: 20px;
        }
        #menu-items-list a {
            text-decoration: none;
            color: #333;
            font-size: 14px;
        }
        #menu-items-list a:hover {
            color: #0066cc;
            background-color: #e6f2ff;
        }
        #menu-items-list li:first-child a {
            font-weight: bold;
            font-size: 18px; /*
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); // Lighter semi-transparent black
            z-index: 999;
        }
        .feed-item {
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .feed-item:hover {
            background-color: #f0f8ff; /* Light blue background on hover */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }
        .feed-item strong {
            transition: color 0.3s ease;
        }
        .feed-item:hover strong {
            color: #0066cc; /* Change title color on hover */
        }
        .feed-item a {
            text-decoration: none;
            color: #0066cc;
            transition: color 0.3s ease;
        }
        .feed-item:hover a {
            color: #004499; /* Darker blue for links on hover */
        }
    `;
    doc.head.appendChild(additionalStyles);

    // Create the body content
    doc.body.innerHTML = `
        <div class="hamburger-menu">
            <button onclick="toggleMenu()">☰</button>
            <div id="menu-items" class="menu-items">
                <button onclick="toggleMenu()" class="close-button">X</button>
                <ul id="menu-items-list"></ul>
            </div>
        </div>
        <h1>${customTitle}</h1>
        <div id="error-message"></div>
        <ul id="feed-list"></ul>
        <div id="overlay"></div>
    `;

    // Create a configuration object
    const configuration = {
        title: customTitle,
        feeds: feeds,
        excludedTerms: Array.from(excludedTerms),
        requiredTerms: Array.from(requiredTerms),
        menuItems: menuItems,
        hiddenItems: Array.from(hiddenItems)
    };

    // Create a new script element
    const script = doc.createElement('script');
    script.textContent = `
        // Configuration
        const feeds = ${JSON.stringify(configuration.feeds)};
        const excludedTerms = new Set(${JSON.stringify(configuration.excludedTerms)});
        const requiredTerms = new Set(${JSON.stringify(configuration.requiredTerms)});
        let feedItems = [];
        let hiddenItems = new Set(${JSON.stringify(configuration.hiddenItems)});
        const menuItems = ${JSON.stringify(configuration.menuItems)};

        function toggleMenu() {
            const menu = document.getElementById('menu-items');
            const overlay = document.getElementById('overlay');
            menu.classList.toggle('active');
            if (menu.classList.contains('active')) {
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        }

        function closeMenuOnOutsideClick(event) {
            const menu = document.getElementById('menu-items');
            const hamburger = document.querySelector('.hamburger-menu > button');
            const overlay = document.getElementById('overlay');
            if (!menu.contains(event.target) && !hamburger.contains(event.target) && menu.classList.contains('active')) {
                toggleMenu();
            }
        }

        function updateMenuItemsList() {
            const menuList = document.getElementById('menu-items-list');
            menuList.innerHTML = '<li><a href="index.html">Home</a></li>';
            menuItems.forEach((item) => {
                const li = document.createElement('li');
                li.innerHTML = \`<a href="\${item.url}" target="_blank">\${item.name}</a>\`;
                menuList.appendChild(li);
            });
        }

        function decodeHTMLEntities(text) {
            const textArea = document.createElement('textarea');
            textArea.innerHTML = text;
            return textArea.value;
        }

        ${fetchFeeds.toString()}
        ${processFeeds.toString()}
        function displayFeeds() {
            const feedList = document.getElementById('feed-list');
            feedList.innerHTML = '';

            if (feedItems.length === 0) {
                feedList.innerHTML = '<p>No items to display.</p>';
                return;
            }

            feedItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'feed-item';
                if (hiddenItems.has(item.link)) {
                    li.classList.add('hidden');
                }

                // Extract title and source
                let title = item.title;
                let source;

                // Check if the title already contains a source (typical for Google News)
                if (item.title.includes(' - ')) {
                    // Keep the title as is, it already has the source
                    source = '';
                } else {
                    // Extract domain name from the link
                    try {
                        const url = new URL(item.link);
                        source = url.hostname.replace('www.', '');
                    } catch (e) {
                        source = 'Unknown Source';
                    }
                    // Append the source to the title
                    title += \` - \${source}\`;
                }

                li.innerHTML = \`
                    <strong>\${title}</strong><br>
                    <small>\${moment(item.pubDate).format('MMMM D, YYYY, h:mm a')}</small><br>
                    <a href="\${item.link}" target="_blank">Read More</a>
                \`;
                feedList.appendChild(li);
            });

            console.log('Displayed feed items:', feedItems.length);
        }
        ${setupAutoRefresh.toString()}
        ${toggleItemVisibility.toString()}
        ${saveHiddenItemsToStorage.toString()}

        document.addEventListener('DOMContentLoaded', function() {
            updateMenuItemsList();
            fetchFeeds();
            setupAutoRefresh();
            window.addEventListener('click', closeMenuOnOutsideClick);
        });
    `;

    // Append the script to the body
    doc.body.appendChild(script);

    // Generate the final HTML content
    const finalHTML = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

    // Create a Blob with the HTML content
    const blob = new Blob([finalHTML], { type: 'text/html' });

    // Create a download link and trigger the download
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'user_version.html';
    downloadLink.click();
}

            
            function addRequiredTerm() {
                const term = document.getElementById('required-term').value.trim();
                if (term && !requiredTerms.has(term)) {
                    requiredTerms.add(term);
                    saveRequiredTermsToStorage();
                    updateRequiredTerms();
                    document.getElementById('required-term').value = '';
                    fetchFeeds(); // Refresh feeds to apply new required term
                }
            }

            function updateRequiredTerms() {
                const requiredTermsDiv = document.getElementById('required-terms');
                requiredTermsDiv.style.border = '1px solid #ccc';
                requiredTermsDiv.style.padding = '10px';
                requiredTermsDiv.style.background = '#f7f7f7';
                requiredTermsDiv.style.marginBottom = '20px';
                requiredTermsDiv.innerHTML = '<h4 style="margin-top: 0;">Required Terms:</h4>';
                if (requiredTerms.size === 0) {
                    requiredTermsDiv.innerHTML += '<p>No required terms.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.style.listStyle = 'none';
                    ul.style.padding = '0';
                    ul.style.margin = '0';
                    requiredTerms.forEach(term => {
                        const li = document.createElement('li');
                        li.style.paddingBottom = '10px';
                        const span = document.createElement('span');
                        span.textContent = term;
                        span.style.marginRight = '10px';
                        li.appendChild(span);
                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.onclick = () => removeRequiredTerm(term);
                        li.appendChild(removeButton);
                        ul.appendChild(li);
                    });
                    requiredTermsDiv.appendChild(ul);
                    const clearButton = document.createElement('button');
                    clearButton.textContent = 'Clear All Required Terms';
                    clearButton.style.background = '#ADD8E6';
                    clearButton.onclick = clearAllRequiredTerms;
                    requiredTermsDiv.appendChild(clearButton);
                }
            }

            function removeRequiredTerm(term) {
                requiredTerms.delete(term);
                saveRequiredTermsToStorage();
                updateRequiredTerms();
                fetchFeeds(); // Refresh feeds to apply updated required terms
            }

            function clearAllRequiredTerms() {
                requiredTerms.clear();
                saveRequiredTermsToStorage();
                updateRequiredTerms();
                fetchFeeds(); // Refresh feeds to apply updated required terms
            }

            function loadRequiredTerms() {
                const storedRequiredTerms = localStorage.getItem('requiredTerms');
                if (storedRequiredTerms) {
                    requiredTerms = new Set(JSON.parse(storedRequiredTerms));
                    updateRequiredTerms();
                }
            }

            function saveMenuItemsToStorage() {
                localStorage.setItem('menuItems', JSON.stringify(menuItems));
            }

            function loadMenuItems() {
                const storedMenuItems = localStorage.getItem('menuItems');
                if (storedMenuItems) {
                    menuItems = JSON.parse(storedMenuItems);
                    updateMenuItemsList();
                }
            }

            function saveConfiguration() {
                const configName = document.getElementById('config-name').value.trim();
                if (!configName) {
                    alert('Please enter a name for the configuration');
                    return;
                }

                const configuration = {
                    title: document.title,
                    feeds: feeds,
                    excludedTerms: Array.from(excludedTerms),
                    requiredTerms: Array.from(requiredTerms),
                    menuItems: menuItems
                };

                let savedConfigs = JSON.parse(localStorage.getItem('savedConfigurations')) || {};
                savedConfigs[configName] = configuration;
                localStorage.setItem('savedConfigurations', JSON.stringify(savedConfigs));

                alert('Configuration saved successfully');
                updateSavedConfigsList();
            }

            function loadConfiguration() {
    const savedConfigs = JSON.parse(localStorage.getItem('savedConfigurations')) || {};
    const configNames = Object.keys(savedConfigs);

    if (configNames.length === 0) {
        alert('No saved configurations found');
        return;
    }

    const selectedConfig = prompt('Enter the name of the configuration to load:\n' + configNames.join(', '));
    if (!selectedConfig || !savedConfigs[selectedConfig]) {
        alert('Invalid configuration name');
        return;
    }

    const config = savedConfigs[selectedConfig];

    // Load the configuration
    document.title = config.title;
    const h1Element = document.querySelector('h1');
    if (h1Element) {
        h1Element.textContent = config.title;
    }
    document.getElementById('page-title').value = config.title;
    localStorage.setItem('customPageTitle', config.title);
    
    // Properly reconstruct feed objects
    feeds = config.feeds.map(feed => ({
        url: feed.url,
        unfiltered: feed.unfiltered,
        requiredTerms: feed.requiredTerms || [],
        excludedTerms: feed.excludedTerms || []
    }));
    
    excludedTerms = new Set(config.excludedTerms);
    requiredTerms = new Set(config.requiredTerms);
    menuItems = config.menuItems;

    // Update UI and storage
    updateFeedSummary();
    updateExcludedTerms();
    updateRequiredTerms();
    updateMenuItemsList();
    saveFeedsToStorage();
    saveExcludedTermsToStorage();
    saveRequiredTermsToStorage();
    saveMenuItemsToStorage();

    // Force a complete refresh of feed-specific terms UI
    updateFeedSelector();
    updateFeedSpecificTerms();

    // Refresh feeds
    feedItems = []; // Clear existing feed items
    fetchFeeds();

    alert('Configuration loaded successfully.');
}

            function updateSavedConfigsList() {
                const savedConfigsDiv = document.getElementById('saved-configs');
                const savedConfigs = JSON.parse(localStorage.getItem('savedConfigurations')) || {};
                const configNames = Object.keys(savedConfigs);

                savedConfigsDiv.innerHTML = '<h4>Saved Configurations:</h4>';
                if (configNames.length === 0) {
                    savedConfigsDiv.innerHTML += '<p>No saved configurations.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.style.listStyleType = 'none';
                    ul.style.padding = '0';
                    configNames.forEach(name => {
                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.justifyContent = 'space-between';
                        li.style.alignItems = 'center';
                        li.style.marginBottom = '10px';
                        li.style.padding = '5px';
                        li.style.backgroundColor = '#f0f0f0';
                        li.style.borderRadius = '5px';
                        const span = document.createElement('span');
                        span.textContent = name;
                        li.appendChild(span);
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.style.marginLeft = '10px';
                        deleteButton.onclick = () => deleteConfiguration(name);
                        li.appendChild(deleteButton);
                        ul.appendChild(li);
                    });
                    savedConfigsDiv.appendChild(ul);
                }
            }

            function deleteConfiguration(name) {
                let savedConfigs = JSON.parse(localStorage.getItem('savedConfigurations')) || {};
                delete savedConfigs[name];
                localStorage.setItem('savedConfigurations', JSON.stringify(savedConfigs));
                updateSavedConfigsList();
                alert('Configuration deleted successfully');
            }

            // Call this function when the page loads
            function initializeConfigManagement() {
                updateSavedConfigsList();
            }

            function saveMenuConfiguration() {
                const configName = document.getElementById('menu-config-name').value.trim();
                if (!configName) {
                    alert('Please enter a name for the menu configuration');
                    return;
                }

                const menuConfiguration = {
                    menuItems: menuItems
                };

                let savedMenuConfigs = JSON.parse(localStorage.getItem('savedMenuConfigurations')) || {};
                savedMenuConfigs[configName] = menuConfiguration;
                localStorage.setItem('savedMenuConfigurations', JSON.stringify(savedMenuConfigs));

                alert('Menu configuration saved successfully');
                updateSavedMenuConfigsList();
            }

            function loadMenuConfiguration() {
                const savedMenuConfigs = JSON.parse(localStorage.getItem('savedMenuConfigurations')) || {};
                const configNames = Object.keys(savedMenuConfigs);

                if (configNames.length === 0) {
                    alert('No saved menu configurations found');
                    return;
                }

                const selectedConfig = prompt('Enter the name of the menu configuration to load:\n' + configNames.join(', '));
                if (!selectedConfig || !savedMenuConfigs[selectedConfig]) {
                    alert('Invalid menu configuration name');
                    return;
                }

                const config = savedMenuConfigs[selectedConfig];

                // Load the menu configuration
                menuItems = config.menuItems;

                // Update UI and storage
                updateMenuItemsList();
                saveMenuItemsToStorage();

                alert('Menu configuration loaded successfully');
            }

            function updateSavedMenuConfigsList() {
                const savedMenuConfigsDiv = document.getElementById('saved-menu-configs');
                const savedMenuConfigs = JSON.parse(localStorage.getItem('savedMenuConfigurations')) || {};
                const configNames = Object.keys(savedMenuConfigs);

                savedMenuConfigsDiv.innerHTML = '<h4>Saved Menu Configurations:</h4>';
                if (configNames.length === 0) {
                    savedMenuConfigsDiv.innerHTML += '<p>No saved menu configurations.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.style.listStyleType = 'none';
                    ul.style.padding = '0';
                    configNames.forEach(name => {
                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.justifyContent = 'space-between';
                        li.style.alignItems = 'center';
                        li.style.marginBottom = '10px';
                        li.style.padding = '5px';
                        li.style.backgroundColor = '#f0f0f0';
                        li.style.borderRadius = '5px';
                        const span = document.createElement('span');
                        span.textContent = name;
                        li.appendChild(span);
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.style.marginLeft = '10px';
                        deleteButton.onclick = () => deleteMenuConfiguration(name);
                        li.appendChild(deleteButton);
                        ul.appendChild(li);
                    });
                    savedMenuConfigsDiv.appendChild(ul);
                }
            }

            function deleteMenuConfiguration(name) {
                let savedMenuConfigs = JSON.parse(localStorage.getItem('savedMenuConfigurations')) || {};
                delete savedMenuConfigs[name];
                localStorage.setItem('savedMenuConfigurations', JSON.stringify(savedMenuConfigs));
                updateSavedMenuConfigsList();
                alert('Menu configuration deleted successfully');
            }

            // Call this function when the page loads
            function initializeMenuConfigManagement() {
                updateSavedMenuConfigsList();
            }

            function updateFeedSelector() {
    const selector = document.getElementById('feed-selector');
    selector.innerHTML = '';
    feeds.forEach((feed, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = feed.url;
        selector.appendChild(option);
    });
}

function addFeedSpecificTerm() {
    const feedIndex = document.getElementById('feed-selector').value;
    const term = decodeHTMLEntities(document.getElementById('feed-specific-term').value.trim());
    const termType = document.getElementById('term-type').value;

    if (term && feedIndex !== '') {
        const feed = feeds[feedIndex];
        if (termType === 'required') {
            if (!feed.requiredTerms.includes(term)) {
                feed.requiredTerms.push(term);
            }
        } else {
            if (!feed.excludedTerms.includes(term)) {
                feed.excludedTerms.push(term);
            }
        }
        saveFeedsToStorage();
        updateFeedSpecificTerms();
        fetchFeeds();
        document.getElementById('feed-specific-term').value = '';
    }
}

function updateFeedSpecificTerms() {
    const termsDiv = document.getElementById('feed-specific-terms');
    termsDiv.innerHTML = '';
    
    feeds.forEach((feed, feedIndex) => {
        if (feed.requiredTerms.length > 0 || feed.excludedTerms.length > 0) {
            const feedDiv = document.createElement('div');
            feedDiv.className = 'feed-specific-terms-item';
            feedDiv.innerHTML = `<h4>${feed.url}</h4>`;
            
            if (feed.requiredTerms.length > 0) {
                feedDiv.innerHTML += '<h5>Required Terms:</h5>';
                const requiredUl = document.createElement('ul');
                feed.requiredTerms.forEach((term) => {
                    const li = document.createElement('li');
                    const span = document.createElement('span');
                    span.textContent = term;
                    li.appendChild(span);
                    const removeButton = document.createElement('button');
                    removeButton.textContent = 'Remove';
                    removeButton.onclick = (e) => {
                        e.preventDefault();
                        removeFeedSpecificTerm(feedIndex, 'required', term);
                    };
                    li.appendChild(removeButton);
                    requiredUl.appendChild(li);
                });
                feedDiv.appendChild(requiredUl);
            }
            
            if (feed.excludedTerms.length > 0) {
                feedDiv.innerHTML += '<h5>Excluded Terms:</h5>';
                const excludedUl = document.createElement('ul');
                feed.excludedTerms.forEach((term) => {
                    const li = document.createElement('li');
                    const span = document.createElement('span');
                    span.textContent = term;
                    li.appendChild(span);
                    const removeButton = document.createElement('button');
                    removeButton.textContent = 'Remove';
                    removeButton.onclick = (e) => {
                        e.preventDefault();
                        removeFeedSpecificTerm(feedIndex, 'excluded', term);
                    };
                    li.appendChild(removeButton);
                    excludedUl.appendChild(li);
                });
                feedDiv.appendChild(excludedUl);
            }
            
            termsDiv.appendChild(feedDiv);
        }
    });
}

function removeFeedSpecificTerm(feedIndex, termType, term) {
    const feed = feeds[feedIndex];
    if (termType === 'required') {
        feed.requiredTerms = feed.requiredTerms.filter(t => t !== term);
    } else {
        feed.excludedTerms = feed.excludedTerms.filter(t => t !== term);
    }
    saveFeedsToStorage();
    updateFeedSpecificTerms();
    fetchFeeds();
}

// Load feeds and set up auto-refresh on page load
loadFeeds();
setupAutoRefresh();
loadCustomTitle();
loadRequiredTerms();
loadMenuItems();
initializeConfigManagement();
initializeMenuConfigManagement();
updateFeedSelector();  
updateFeedSpecificTerms();  
</script>
</body>
</html>